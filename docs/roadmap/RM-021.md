# RM-021 — Environmental Simulation Layer

- **PX Anchor:** [PX-021.1](../prompts/PX-021.1.md), [PX-021.4](../prompts/PX-021.4.md)*, [PX-021.5](../prompts/PX-021.5.md)*
- **Status:** Active
- **Owner:** Systems & Presentation
- **Branch Prefix:** `feature/RM-021-environment`

## Overview
Extend the simulation beyond factory internals into a responsive world layer. Temperature, light, humidity, and air quality evolve along seasonal and prestige curves, gently modulating power efficiency, feed consumption, and aesthetics without punitive spikes.
Mirror the comfort-idle sandbox intent documented in the [Idle Game Comparative Analysis](../analysis/IdleGameComparative.md) when tuning modifiers and ambience.

## Key Objectives
- Track environmental factors with authored curves instead of random swings.
- Feed environmental state into power services (RM-018) and factory layout bonuses (RM-019).
- Drive visual/audio cues, sandbox diorama props, and top-banner weather indicators (RM-020, RM-010).
- Unlock Space Colony environmental controls as a prestige milestone.
- Provide shared data to both **Reactive Diorama** and **Top-Down Map** visualizations without duplicating sim work.

## Dependencies
- Inputs from [RM-018 — Power & Resource Layer](RM-018.md) and [RM-019 — Factory Layout System](RM-019.md).
- Outputs to [RM-020 — Art / Audio Pipeline](RM-020.md) for visuals/audio and to [RM-010 — UI & Control Architecture](RM-010.md) for HUD integration.
- Supersedes legacy Environment Director notes (`docs/prompts/RM-010.md`); merge or archive remaining details into PX-021.1.

## Recent Progress
- `EnvironmentService.gd` lives under `src/services/`, runs as an autoload, and streams seasonal curves from `data/environment_profiles.tsv`.
- Feed drain/refill, base PPS, and autoburst gating respond to the service's modifiers so environment shifts influence the loop in real time.
- `EnvPanel.tscn` replaces the legacy pollution overlay with a summary header, preset selector, and expandable detail grid fed by service signals.
- Retired the legacy `EnvironmentDirector` autoload and associated script files; documentation now points designers to `EnvironmentService` as the single source of truth.
- Designers can cycle seasonal presets in-game via the panel dropdown; telemetry continues to log per-factor snapshots every 20 seconds.
- Sandbox integration spec approved: EnvironmentService emits normalized factors, `SandboxService` maps them to a 32×18 CA grid (scaled down from 40×22 to keep ticks under budget), and StatBus/Economy receives a Comfort Index bonus capped at +5 % PPS.
- EnvPanel now surfaces sandbox comfort metrics, showing the live index and +% bonus alongside environment stats and tooltips.
- SandboxService exposes configurable smoothing/skip cadence so visual layers can consume stable snapshots without stalling the 10 Hz spine.
- UI tablet layout docks the Environment panel and Home sheet in the side column to keep the sandbox viewport and feed controls from overlapping.
- Factory viewport frames the sandbox above the conveyor belt so both remain visible at tablet/desktop breakpoints.
- Sandbox renderer toggle (`Config.env_renderer`) wired; CPU renderer feeds StatsProbe and dashboard (`sandbox_tick_ms`, `sandbox_render_ms`).
- Shared CA buffer now drives both the diorama view and planned top-down map view; doc updates capture the dual-visual roadmap.

## Acceptance Outline
Full criteria captured in PX-021.1. Highlights:
1. `EnvironmentService.gd` maintains temperature, light, humidity, air quality with configurable curves.
2. Environmental state influences power efficiency, feed modifiers, and prestige ambience in gentle ranges.
3. UI exposes a weather icon and expandable environment panel showing live values.
4. Art/audio layers react to day/night cycle and climate state.
5. Space Colony unlock introduces stable-climate presets.

## Next Steps
- Author milestone profiles in `/data/environment_profiles.tsv` and ensure EnvironmentService swaps them on tier milestones.
- Extend EnvPanel branch routing for future PX-021.2/021.3 work once additional presets and toggles arrive.
- PX-021.4: Era-based Diorama evolution (assets, camera, tint modulation) without resetting the sim.
- PX-021.5: Alternate map renderer + view toggle, sharing CA data; ensure instant swap and telemetry.
- PX-014.3: Optional timelapse capture + nightly dashboard hook once map view lands.
