# Metrics Dashboard Specification

> Defines nightly dashboard generation for telemetry and performance monitoring. Terminology: [Glossary](../Glossary.md).

## Pipeline
1. **PR Smoke Artifacts:** CI runs `scripts/telemetry_replay_demo.py` for every pull request and uploads `artifacts/telemetry/kpi.json` + `kpi_chart.png` for reviewer spot checks.
2. **Input Data:** Nightly JSON logs from `/reports/nightly/` generated by PX-014.2 and replay jobs.
3. **Processor:** `tools/gen_dashboard.py` reads JSON, aggregates via Pandas, outputs CSV + HTML.
4. **Graphs:**
   - `sandbox_tick_ms_p95`
   - `pps_avg`
   - `ci_avg`
   - `power_ratio_avg`
   - `sandbox_render_fallback_ratio`
   - `economy_tick_ms_p95`
   - `eco_ship_ms_p95`
5. **Output:** `/reports/dashboard/index.html` with timestamp, summary table, inline graphs, and run history columns for sandbox fallback share + active view.
6. **CI Integration:** Nightly job `generate-dashboard` runs after `replay-nightly`, uploads HTML + assets as artifacts, and pushes to `gh-pages` (or equivalent).
7. **Alerts:** Metric drift >15 % week-over-week flagged in summary (`alerts` section with owner + recommended action). Economy sub-phase monitors add hard alerts when `economy_tick_ms_p95 > 10 ms` or `eco_ship_ms_p95 > 7 ms`.
8. **Dependencies:** Python 3.10+, `pandas`, `matplotlib`, `jinja2` listed in `tools/requirements.txt`.
9. **Ownership:** QA automation lead; secondary owner systems engineer.
10. **Data Retention:** Keep last 30 days of dashboards; archive older ones under `reports/dashboard/archive/`.

## PR Artifact Review
- Download `kpi.json` and `kpi_chart.png` from CI artifacts. Confirm:
  - `summary.final.ci` within ±3 % of baseline unless change is justified.
  - `summary.alerts` empty; if populated, mitigation or sign-off noted in the PR.
  - Chart trend sustains comfort expectations (no drops below 40 without design approval).
- Record KPI shifts >3 % in the PR description and link to the artifact paths. Required for RM-011, RM-012, RM-013, RM-018, and RM-021 changes.
- Attach reviewed artifacts to the gate checklist defined in [Release Milestones](../ops/Release_Milestones.md) when advancing phases.

## Comfort Index Diff Workflow
1. Pull the latest nightly baseline (`reports/nightly/latest.json`) and the PR artifact (`artifacts/telemetry/kpi.json`).
2. Compare the two with the dashboard tooling:
   ```bash
   python3 tools/gen_dashboard.py --diff reports/nightly/latest.json artifacts/telemetry/kpi.json
   ```
3. If `ci_avg` delta exceeds 5 %, log a note under the PR’s Telemetry checklist and alert the owning RM.
4. Persistent shifts (>48 h) go in the [Risk Register](Risk_Register.md); update `docs/design/Balance_Playbook.md` if the new comfort curve becomes canonical.

## Command Example
```bash
python3 tools/gen_dashboard.py --input reports/nightly --output reports/dashboard/index.html
```

## References
- [Telemetry & Replay](../quality/Telemetry_Replay.md)
- [CI Pipeline](../qa/CI_Pipeline.md)
- [Risk Register](Risk_Register.md)
