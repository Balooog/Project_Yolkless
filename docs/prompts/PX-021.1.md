# PX-021.1 — Environmental Simulation Layer
**Targets:** RM-021  
**Date:** 2025-10-22  
**Outcome:** Active
*Update 2025-10-23:* Legacy `EnvironmentDirector` scripts were removed from the project; this prompt now tracks `EnvironmentService` as the canonical implementation.
*Update 2025-10-23 (Sandbox Integration):* EnvironmentService remains authoritative, now driving the companion SandboxService that computes a Comfort Index bonus for the economy loop.

## Driver Prompt
# Project Yolkless – PX-021.1  
### Environmental Simulation Layer (Targets RM-021)

---

## 1. Scope
Build a reactive environment service that models temperature, light level, humidity, and air quality. These factors gently influence power efficiency, feed consumption, and prestige ambience while coordinating visual/audio cues across the day/night cycle.
Follow the comfort-idle benchmarks in `docs/analysis/IdleGameComparative.md` so every modifier supports calm, restorative play.

## 2. Functional Objectives
1. **Environment Service**
   - `EnvironmentService.gd` tracks factors over time using designer-authored curves and seasonal presets.
   - Supports manual overrides for testing and prestige-tier variants (e.g., Space Colony stability).
2. **Power Integration**
   - Temperature modifies generator efficiency via RM-018 hooks.
   - Light level affects solar output or mood lighting modifiers.
3. **Factory Effects**
   - Humidity tweaks feed consumption rates (RM-011) and automation thresholds (RM-013).
   - Air quality improves with wisdom (RM-015) and influences prestige bonuses.
4. **Presentation Layer**
   - Update top-banner weather icon and expand-to-panel UI (RM-010).
   - Drive visual, audio, and lighting cues (RM-020) for day/night transitions.
5. **Data Authoring**
   - Store seasonal presets in `data/environment_profiles.tsv`.
   - Provide tooling hooks to preview timelines and export telemetry (RM-014).

## 3. Architecture Notes
- Service runs as an autoload singleton with signals (`environment_updated`, `day_phase_changed`).
- Each factor has configurable range clamps, easing functions, and prestige modifiers.
- Integrate with save system to persist cycle state across sessions.
- Ensure headless simulations can advance environment normally for balance testing.
- Legacy Environment Director behavior now lives inside this service; keep deprecated scripts/docs archived for reference only.

## 4. Acceptance Criteria
1. Environment factors evolve according to configured curves and respond to prestige season selections.
2. Power and feed systems receive modifier callbacks and apply them without destabilizing the economy.
3. UI weather icon reflects current conditions; expanding panel lists factor values with tooltips.
4. Visual/audio cues respond smoothly to transitions without abrupt jumps.
5. Environment state saves/loads correctly and emits telemetry for QA baseline comparisons.

## 5. Deliverables
- `/src/services/EnvironmentService.gd`
- `data/environment_profiles.tsv` with seasonal/presige presets.
- UI widget `ui/widgets/EnvPanel.tscn` and HUD integration updates.
- Updated docs in `/docs/roadmap/RM-021.md` and migration notes replacing Environment Director references.
- Sandbox integration deliverables (Environment profiles, SandboxService, CI wiring) — see update below.
- Headless simulation tests demonstrating environment impact logging.

## 6. Future Extensions
- Weather events tied into RM-016 event scheduler.
- Player-controlled climate sliders unlocked mid-prestige.
- Multi-biome support for future expansions.

**Linked Roadmap:** RM-021 – Environmental Simulation Layer  
**Branch Convention:** `feature/RM-021-environment`  
**Parent Epic:** World Atmosphere & Mood

---

## Sandbox Integration Addendum (PX-021.1)

### Scope
Fold the Sandbox Simulation under EnvironmentService. The sandbox visualises environmental factors and emits a positive Comfort Index (CI) bonus while EnvironmentService keeps control of state and milestones.

### Objectives
1. Keep EnvironmentService the authoritative data source.
2. Extend EnvironmentService with normalized factors (`temperature`, `light`, `humidity`, `season`, `weather_state`) and an `environment_changed(factors)` signal.
3. Introduce `SandboxService` to listen for factor changes, run the lightweight 32×18 cellular sandbox, and emit `ci_changed(ci, bonus)`.
4. Feed the sandbox bonus into StatBus/Economy as an additive PPS modifier (`ci_bonus`).
5. Surface the CI bonus with a small HUD tooltip/tab entry in EnvPanel.

### Architecture Overview
```
EnvironmentService
├── profiles/curves (milestones drive profile swaps)
├── emits environment_changed(factors)
│
├─► PowerService          (solar modifiers)
├─► UI EnvPanel           (weather icon + tooltip)
└─► SandboxService
    ├─ maps factors → sandbox inputs (breeze, moisture, heat)
    ├─ runs CA simulation (32×18 grid)
    ├─ computes comfort_index (0–1)
    └─ emits ci_changed(ci, bonus)
        │
        └─► StatBus/Economy (additive PPS modifier)
```

### Data Contracts
- **EnvironmentService.gd**
  ```gdscript
  func current_factors() -> Dictionary:
      return {
          "temperature": _temp,
          "light": _light,
          "humidity": _humidity,
          "season": _season,
          "weather_state": _weather
      }

  signal environment_changed(factors: Dictionary)
  ```
- **SandboxService.gd**
  ```gdscript
  func set_inputs(breeze: float, moisture: float, heat: float) -> void
  func get_ci() -> float
  func get_ci_bonus() -> float
  signal ci_changed(ci: float, bonus: float)
  ```
- **StatBus / Economy**
  ```gdscript
  register_modifier("sandbox", "ci_bonus", bonus)
  ```

### Environment → Sandbox Mapping
| Environment Factor | Sandbox Input | Description |
| ------------------ | ------------- | ----------- |
| `light`            | `breeze`      | Drives wind animation; brighter light = stronger breeze. |
| `humidity`         | `moisture`    | Controls vapor and foliage response. |
| `temperature`      | `heat`        | Normalized between profile min/max. |
| `weather_state`    | `preset`      | Optional forced scenario (“rain”, “clear”). |

Inputs are smoothed with EMA to avoid flicker.

### Comfort Index & Bonus
- CI derived from sandbox stability, diversity, and entropy.
- Output range `[0, 1]`.
- Bonus formula `ci_bonus = clamp(ci * 0.05, 0.0, 0.05)` (max +5% PPS).
- `ci_changed` emitted every 1–2 seconds with smoothing.
- Bonus is strictly additive; never reduces PPS.

### Milestone Profiles
| Milestone           | Profile        | Visual Theme      | Transition |
| ------------------- | -------------- | ----------------- | ---------- |
| Backyard Coop       | `early_farm`   | Morning palette   | baseline |
| Small Farm          | `mid_growth`   | Golden daylight   | 15s smooth fade |
| Industrial Plant    | `industrial_push`  | Urban dusk tones  | Soft dusk |
| Eco Revival         | `eco_revival`  | Lush teal flare   | Warm bloom |
| Off-World Habitat   | `colony_alpha` | Off-world light   | Aurora sweep |

Profiles are defined in `/data/environment_profiles.tsv`.

### Save Schema Extensions
```json
{
  "environment": {
    "profile": "mid_growth",
    "factors": {"temperature": 23.5, "light": 0.78, "humidity": 0.52, "season": "spring"},
    "version": 1
  },
  "sandbox": {
    "seed": 123456,
    "preset": "oasis",
    "ci": 0.36,
    "bonus": 0.036,
    "version": 1
  }
}
```

### Sandbox Deliverables
| File | Description |
| ---- | ----------- |
| `/src/services/EnvironmentService.gd` | Emits normalized factors, handles milestone profile swaps. |
| `/src/services/SandboxService.gd` | Cellular sandbox + CI computation + listener hooks. |
| `/src/sandbox/` | Rendering, presets, simulation assets. |
| `/data/environment_profiles.tsv` | Milestone curve definitions. |
| `/ui/panels/EnvPanel.tscn` | Tooltip/tab showing profile & comfort bonus. |

### Acceptance Criteria (Supplemental)
1. Sandbox responds to live factors and CI updates smoothly.
2. Economy sees `ci_bonus` applied without pulling PPS below baseline.
3. Sandbox tick stays ≤2 ms at 32×18.
4. Milestone profile swaps drive visual/weather shifts via EnvironmentService.
5. Save/load restores both environment and sandbox state.
6. HUD tooltip reports “Comfort Bonus +x.xx %”.
7. Data flows one-way (sandbox → economy) to avoid feedback loops.

### Future PX References
- PX-021.2 – Environment milestone transitions, weekly seeds, telemetry.
- PX-021.3 – Token particles, GPU path, colony diorama integration.

**Branch:** `feature/RM-021-sandbox-integration`  
**Command:** `codex start RM-021`
