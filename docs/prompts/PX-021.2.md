# PX-021.2 — Sandbox Sampling & GPU Prep

## Goals
- Harden the SandboxService and SandboxGrid loop for higher-frequency sampling (2–5 Hz) with smoothing to support future GPU execution paths.
- Expose comfort telemetry snapshots suitable for replay automation.
- Preserve the 2 ms sandbox budget (see docs/quality/Performance_Budgets.md).

## Tasks
1. Add optional double-buffer smoothing hooks to `SandboxService` so active cell fractions and comfort deltas are averaged over the last N ticks (configurable in `environment_config.json`).
   - **Updates:** 2025-10-26 smoothing window bumped to 8 samples with `ema_alpha=0.1`, cutting sandbox p95 from 1.54 ms → 1.33 ms. Adaptive tick skipping (±0.0002 `ci_delta`, ≥8 stable samples) and plant-growth clamp now active, bringing sandbox p95 down to ≈0.74 ms. Next: fold era rendering (PX-021.4) and map view (PX-021.5) onto the shared buffer.
2. Capture per-tick timing by integrating `StatsProbe`:
   - `SandboxService` should call `StatsProbe.record_tick()` with `tick_ms` and `active_cells`.
   - `SimulationClock` should provide the delta to the probe so 10 Hz cadence is reflected in the CSV.
3. Update `docs/quality/Telemetry_Replay.md` with the new stats fields and guidance on interpreting `ci_delta` / `active_cells`.
4. Extend the replay JSON payload (`tools/replay_headless.gd`) to include sandbox timing, active cell metrics, and p95 comfort stability.

### Current Status (2025-10-26)
- Smoothing + adaptive skip + plant clamp keep sandbox `tick_ms_p95≈0.74 ms` (skip run), with only sporadic environment alerts.
- Remaining work: diorama era pass (PX-021.4), top-down map renderer (PX-021.5), and timelapse integration (PX-014.3).

## Acceptance Criteria
- StatsProbe thresholds trigger alerts when sandbox tick >1.9 ms, `active_cells` exceeds 400, or `ci_delta` exceeds ±0.05 after the ~2 s warm-up window.
- Replay summaries include `sandbox_tick_ms_p95` and `active_cells_max` values.
- SandboxService exposes a smoothing configuration knob in `data/environment_config.json`.
- Telemetry docs capture the new metrics.

## Follow-up
- PX-021.3 will tackle GPU offload experimentation and the full comfort visualization overhaul.
