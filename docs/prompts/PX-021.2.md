# PX-021.2 — Sandbox CA Implementation
**Targets:** RM-021 — Environmental Simulation Layer  
**Date:** 2025-10-24  
**Outcome:** Planned  

## Scope
Replace the placeholder comfort calculation with the full cellular automata (CA) pipeline.  Implement the 128×72 grid, environment-driven material rules, and final Comfort Index computation that feeds StatBus and UI.

## Objectives
1. Implement CA tick loop with double-buffered 2D arrays (`materials[128][72]`).  
2. Define base material types: air, sand, water, oil, fire, plant, stone, steam.  
3. Map EnvironmentService inputs (heat, moisture, breeze) to CA parameters.  
4. Compute Comfort Index from stability, diversity, and entropy scores; clamp bonus to +5 %.  
5. Emit `ci_changed(ci, bonus)` at 2 Hz and update StatBus keys `comfort_index` / `ci_bonus`.  
6. Log CI component breakdown (base, vegetation, stress penalty) for telemetry validation.  

## Deliverables
- `/src/sandbox/SandboxGrid.gd` — grid engine + tick logic.  
- `/src/sandbox/MaterialRules.gd` — material behaviours and transitions.  
- Telemetry helpers under `tools/` for CI logging.  
- `/tests/sandbox/test_ci_balance.gd` — verifies convergence and performance.  
- Updated docs: `docs/design/Environment_Playbook.md`, `docs/architecture/Signals_Events.md`, `docs/quality/Telemetry_Replay.md`.  

## Validation
- Dev build stress test (temperate preset) keeps CI between 0.55–0.65 after 120 s.  
- Headless replay (`replay_headless.gd`) outputs CI samples matching expectations.  
- Profiler shows CA logic ≤ 2 ms per tick at 10 Hz with ≤ 500 active cells.  
- StatBus clamp log triggers if `ci_bonus` attempts to exceed 0.05.  
