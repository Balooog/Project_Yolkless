# PX-021.3 — Sandbox Viewport Renderer Integration
**Targets:** RM-021 — Environmental Simulation Layer  
**Branch:** `feature/RM-021-sandbox-viewport`  
**Status:** Planned

## 1. Scope
Replace the prototype `CanvasPlaceholder` with a live sandbox viewport that renders the CA grid supplied by `SandboxService`. The renderer must surface Comfort Index metrics in the HUD, participate in telemetry, and fall back gracefully when performance budgets are exceeded.

## 2. Core Objectives
1. Author `scenes/sandbox/SandboxCanvas.tscn` with companion script `SandboxCanvas.gd`.
2. Implement `/src/sandbox/SandboxRenderer.gd` to manage pixel-buffer uploads from sandbox grid data.
3. Update `game/scripts/Main.gd` so the sandbox viewport mounts in place of `EnvironmentRoot` when `Config.env_renderer == "sandbox"`, while retaining a legacy fallback.
4. Integrate with `StatsProbe` to record `sandbox_render_ms`, `sandbox_render_ms_avg`, `sandbox_render_ms_p95`, and `sandbox_uploads_per_sec`, keeping logic ≤2 ms and render ≤1 ms.
5. Extend `ui/widgets/EnvPanel.gd` to expose a Comfort tooltip (`Comfort +X.XX %`) refreshed at ≤2 Hz.
6. Implement automatic fallback that halves render cadence when frame p95 exceeds 18 ms for five consecutive seconds, restoring full-rate once the budget stabilises.

## 3. Integration Points
| System | Responsibility |
| --- | --- |
| `SandboxService` | Supplies double-buffered grid frames, Comfort Index values, and CI bonus signals. |
| `EnvironmentService` | Provides profile factors that influence renderer colour grading and tone. |
| `StatsProbe` | Collects renderer timing, upload counts, and dirty pixel telemetry. |
| `Main.gd` | Chooses between sandbox viewport or legacy `EnvironmentRoot` based on config. |
| `EnvPanel` | Displays live Comfort bonus and tooltip text fed by sandbox renderer data. |

## 4. Renderer Logic
- Grid resolution: 128×72 logical cells, scaled via nearest-neighbour to match viewport size.
- Maintain dual cadence: logic at 20–30 Hz, draw at 60 Hz. Skip rendering when frame hashes match previous output.
- Track dirty cell rectangles to minimise `Image` writes; reuse `Image`/`ImageTexture` buffers with no per-frame allocation.
- Load colour lookups from `data/materials.tsv` for consistency with art tokens. Future shader effects hook into the same renderer.

## 5. Files to Create / Modify
```
scenes/sandbox/SandboxCanvas.tscn
scenes/sandbox/SandboxCanvas.gd
src/sandbox/SandboxRenderer.gd
game/scripts/Main.gd
game/scripts/Config.gd
ui/widgets/EnvPanel.gd
```

## 6. Performance & Telemetry Requirements
- Budgets: sandbox logic ≤2 ms, sandbox render ≤1 ms at target 30/60 Hz cadences.
- Record StatsProbe metrics at 1 Hz: `sandbox_render_ms_avg`, `sandbox_render_ms_p95`, `sandbox_uploads_per_sec`, and `sandbox_dirty_pixels_avg`.
- Add nightly replay output fields and PNG graph overlays for the new metrics; ensure `tools/ci_smoke.sh` asserts the sandbox renderer loads.

## 7. Acceptance Criteria
1. Sandbox viewport animates the CA grid; prototype placeholder removed.
2. `Main.gd` mounts `SandboxCanvas` when sandbox renderer is enabled via config, otherwise reverts to legacy environment visuals.
3. EnvPanel tooltip displays `Comfort +X.XX %`, updating at most every 0.5 s.
4. Renderer stays within performance budgets; fallback triggers after sustained p95 >18 ms and recovers automatically once under budget.
5. Renderer output is deterministic: identical seed + preset produces matching frame hashes (±1 pixel tolerance).
6. `./tools/ci_smoke.sh` passes and reports sandbox renderer availability.

## 8. Tests & Tooling
- `/tests/sandbox/test_renderer_scene.gd`: validates scene instantiation and node wiring.
- `/tests/sandbox/test_renderer_perf.gd`: simulates 10 000 frames and asserts p95 render ≤1 ms.
- `/tools/stress_sandbox.gd`: drives high dirty-cell churn to exercise fallback thresholds.
- Update `./tools/ci_smoke.sh` to verify SandboxCanvas loads when the config flag is active.

## 9. Rollback Plan
- Persist `Config.env_renderer` option to toggle between sandbox viewport and legacy environment. No save schema changes required; existing telemetry continues to function.

## 10. Footers
```
RM: RM-021
PX: PX-021.3
Branch: feature/RM-021-sandbox-viewport
```
