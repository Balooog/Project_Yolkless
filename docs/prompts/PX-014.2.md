# PX-014.2 — CLI Replay & Performance Instrumentation
**Targets:** RM-014 — Telemetry & QA Pipeline  
**Date:** 2025-10-24  
**Outcome:** Planned  

## Scope
Deliver a deterministic headless replay tool with built-in performance instrumentation and scenario switching to support regression testing and dashboards.

## Objectives
1. Implement CLI entry point:  
   `godot --headless --path . --script res://tools/replay_headless.gd --duration=<sec> --seed=<int> [--strategy=<mode>]`.  
   Supported strategies: `normal`, `burst`, `idle`.  
2. Sample metrics every tick: `pps`, `ci`, `power_ratio`, `tick_ms`, `active_cells`.  
3. Write summary JSON to `logs/telemetry/replay_<timestamp>.json` with mean, p95, max per metric and scenario metadata.  
4. Emit CSV (optional flag) for quick spreadsheet analysis.  
5. Compare collected stats against `Performance_Budgets.md`; log WARN if thresholds exceeded.  
6. Provide helper script/test (`tests/replay/test_replay_headless.gd`) to validate deterministic seeds.  

## Instrumentation & Automation Hooks
1. **StatsProbe Integration**
   - Add `/src/services/StatsProbe.gd` to sample per-tick metrics (`tick_ms`, `pps`, `ci`, `active_cells`, `power_ratio`).
   - Probe writes CSV snapshots to `logs/perf/tick_<timestamp>.csv` every 10 s and emits `stats_probe_alert(metric, value, threshold)`.
2. **Budget Alert Thresholds**
   - Threshold table:
     | Metric | Threshold | Action |
     | ------ | --------- | ------ |
     | `tick_ms` | p95 > 5 ms | warn + log “Perf spike” |
     | `active_cells` | > 500 | warn |
     | `ci` delta | > 0.1 / s | note instability |
   - Alerts aggregate into the replay summary JSON payload.
3. **Nightly Replay Publishing**
   - Cron job `replay-nightly` runs:
     ```bash
     godot --headless --path . --script res://tools/replay_headless.gd --duration=300 --seed=42
     ```
   - Stores outputs under `/reports/nightly/<date>.json` and `/reports/nightly/<date>.png` (graph).
   - Compares core metrics against previous run; flag ±15 % drift as “⚠️ Perf drift”.
4. **Telemetry_Replay.md Alignment**
   - Update documentation to list StatsProbe fields and artifact naming, referencing sections 17–25.
   - Note that advanced strategies (`--strategy=burst`) are deferred to PX-014.3.

## Deliverables
- `/tools/replay_headless.gd` — CLI driver.  
- `/tools/replay_strategies.gd` — strategy definitions.  
- `/tests/replay/test_replay_headless.gd`.  
- Documentation updates: `Telemetry_Replay.md`, `Performance_Budgets.md`.  
- `/src/services/StatsProbe.gd` — instrumentation layer.  
- `/reports/nightly/` — committed stub folder with README.  
- CI job `nightly-replay` wired into Codex/GitHub automation.  

## Validation
- Running 300 s replay with default strategy produces identical JSON for identical seeds.  
- JSON includes comfort/power/shipment arrays and aggregated stats.  
- WARN log if any metric exceeds budget; otherwise INFO summary.  
- Execution completes under 2 × real time on target hardware.  
- StatsProbe logs show p95 tick ≤ 5 ms and alerts surface in replay summary.  
- Nightly replay artifacts (JSON + PNG) generated automatically with no manual steps.  
