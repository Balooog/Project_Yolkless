# PX-016.1 — Upgrade & Research System
**Targets:** RM-012  
**Date:** 2025-10-22  
**Outcome:** Planned

## Driver Prompt
# Project Yolkless – PX-016.1  
### Upgrade & Research System (Targets RM-012)

---

## 1. Scope
Create a unified framework for credits-based upgrades and research point unlocks. Data lives in TSV files with prerequisite chains, and UI presents both linear shop lists and a research graph. Maintain discovery cadence and UX harmony per the comfort-idle guidance in `docs/analysis/IdleGameComparative.md`.

## 2. Functional Objectives
1. **Schema & Validation**
   - Define TSV columns for id, category, cost, multipliers, prerequisites.
   - Support both soft-currency and research currencies.
   - Implement `/tools/validate_tables.py` rules for upgrade/research DAG checks; wire into CI per `docs/data/Schemas.md`.
2. **Unlock Progression**
   - Research nodes unlock upgrades and automation tiers.
   - Passive RP tick and milestone-based RP injections.
3. **UI Implementation**
   - Shop tab for linear purchase flow with tooltips.
   - Research Lab tab visualizing unlock graph with statuses.
4. **Signals & Telemetry**
   - Emit events on purchase/unlock for ShopDebug and telemetry.
5. **Persistence**
   - Save/load upgrade ownership, research progress, and RP totals.

## Data Validation & Schema Enforcement
1. **Validator Path:** `/tools/validate_tables.py`
   - CLI usage:
     ```bash
     ./tools/validate_tables.py --tables=data/upgrade.tsv,data/research.tsv --schema=docs/data/Schemas.md
     ```
   - Performs:
     - TSV header conformity check (column names & types).
     - Empty-cell scan and cost/level bounds check.
     - DAG verification for `requires` / `unlocks` (no cycles).
     - Row uniqueness across `id` + `tier`.
2. **CI Integration**
   - Add job `validate-tables` that runs on changes under `data/`.
   - Fails on non-zero exit or schema drift; emits logs to `logs/validation/YYYYMMDD.log`.
3. **Contract**
   - Upgrade/research TSVs must validate cleanly before build/test stages.
   - Codex automation runs the validator prior to economy or research spec generation.

## 3. Architecture Notes
- Extend `Balance.gd` parsing to load new TSV schema.
- Introduce `Research.gd` service with RP accrual and unlock validation.
- Rework `ShopService.gd` to consume unified data and expose reason codes.
- UI builds on `Main.tscn` panels; leverage theme tokens from RM-010.
- Connect to automation gating (RM-013) and prestige resets (RM-015).

## 4. Acceptance Criteria
1. TSV updates hot-reload without restarting the game.
2. Shop UI displays availability, costs, and blocking reasons accurately.
3. Research Lab graph updates when nodes unlock or become purchasable.
4. Passive RP tick and milestone rewards align with balance targets (RM-011).
5. Save/load reproduces state exactly after restart.
6. `tools/validate_tables.py` reports “No cycles detected” and exits 0 against default data; CI surface shows ✅ Tables Validated.

## 5. Deliverables
- Updated TSV files in `data/` (migrate from `game/data/`).
- Revised `ShopService.gd`, `Research.gd`, and UI scenes.
- Developer docs explaining schema and data entry workflow.
- `/tools/validate_tables.py` update covering upgrade/research schema enforcement; CI hook documented in README/Build Cookbook.
- `/tests/data/test_validate_tables.gd` validating error paths and happy path.
- Automated tests covering unlock validation and save round-trips.
- Telemetry hooks for upgrade purchase timing.

## 6. Future Extensions
- Multi-stage research projects requiring time/inputs.
- Prestige-only research tree expansions.
- Community mod support for custom upgrade packs.

**Linked Roadmap:** RM-012 – Upgrade & Research System  
**Branch Convention:** `feature/RM-012-upgrades`  
**Parent Epic:** Progression Framework
