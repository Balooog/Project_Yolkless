# PX-019.1 — Sandbox Viewport Integration

## Summary
PX-019.1 finalizes the integration of the **Sandbox environment visuals** into the stable UI baseline established in PX-018.  It unifies the EnvironmentStage render path, camera transforms, and world-layer ordering so that the headless and interactive builds produce identical viewport frames.

---

## Objectives
- Merge the world-space **EnvironmentStage_Backyard** scene with the UI viewport used by the baseline HUD.
- Define deterministic camera behavior for both **headless** and **interactive** runs.
- Confirm safe-area alignment between the HUD dock and the world render region.
- Ensure reproducible lighting and materials across Vulkan, OpenGL, and Xvfb (software) drivers.

---

## Scene Tree & Layering
```
root
├─ WorldViewport (Z-0)
│   ├─ EnvironmentStage_Backyard.tscn
│   │   ├─ LightingRig
│   │   ├─ StaticMeshes
│   │   ├─ DynamicProps
│   │   └─ SkyDome
│   └─ WorldCamera (orthographic, 1280×720 safe framing)
├─ UIRoot (CanvasLayer 0, Z-1)
│   ├─ HUD_StatusBase.tscn
│   ├─ TooltipLayer (hidden baseline)
│   └─ ToastLayer (hidden baseline)
└─ FXOverlay (CanvasLayer 1, Z-2, disabled baseline)
```

- **WorldViewport** renders at full 1280 × 720, letterboxed to preserve aspect ratio in CI captures.  
- **UIRoot** anchors to the same origin, guaranteeing a one-pixel alignment between world and HUD boundaries.  
- **FXOverlay** remains empty in baselines; used only in smoke scenes for weather or flash effects.

---

## Rendering Drivers
| Driver | Environment | Result | Notes |
|:-------|:-------------|:--------|:------|
| Vulkan (hardware or Lavapipe) | Ubuntu desktop / CI w GPU | ✅ Deterministic frame hash ±1 px RMS | Preferred |
| OpenGL 3 (llvmpipe) | Xvfb fallback | ✅ Acceptable parity; minor color variance | CI fallback |
| Dummy / Headless | No display | ⚠️ Renders skipped, produces black frame | Used only when environment disabled |

Headless builds default to **Lavapipe Vulkan** when available.  
CI jobs export the active driver via `vulkaninfo` for traceability.

---

## Camera Calibration
- **Projection:** Orthographic, 1 px = 1 unit mapping.  
- **Safe Area:** 32 px side, 24 px top margins identical to HUD baseline.  
- **Motion Parallax:** Disabled in baselines; sandbox and economy ticks drive movement in replay only.  
- **Lighting:** Fixed exposure 1.0, single directional light (rotation 45° / –30°).  
- **SkyDome:** Static color `#1E2429` to match baseline background when FX off.

---

## Determinism & CI Verification
1. Run headless capture:
   ```bash
   ./tools/run_headless_godot.sh
   python3 tools/ui_assert_baseline.py --images dev/screenshots/ui_baseline
   ```

2. Replay test (300 s) confirms environment and HUD ticks remain within:

   * `sandbox_tick ≤ 2.5 ms`
   * `economy_tick ≤ 1.8 ms`
3. `tools/replay_headless.gd` compares frame hashes against stored baselines; deviation ≤ 2 % RMS.

---

## Dependencies

* PX-018 HUD Baseline (layout contract)
* PX-019.0 Overview (integration rationale)
* `EnvironmentStage_Backyard.tscn` assets committed under `game/scenes/modules/environment/`

---

## Acceptance

|   ID   | Requirement                                                            | Method                             |
| :----: | ---------------------------------------------------------------------- | ---------------------------------- |
| **A1** | EnvironmentStage_Backyard renders in unified viewport with HUD visible | Headless capture                   |
| **A2** | Camera alignment within 1 px of baseline safe area                     | `ui_assert_baseline.py` comparison |
| **A3** | Frame hash deterministic across Vulkan ↔ OpenGL                        | Replay diff ≤ 2 % RMS              |
| **A4** | Lighting and exposure static in baseline                               | Visual inspection / hash check     |
| **A5** | Toast and tooltip regions empty in baseline captures                   | Linter PASS                        |

---

*Last updated {{ site.time | date: "%Y-%m-%d %H:%M UTC" }}*
