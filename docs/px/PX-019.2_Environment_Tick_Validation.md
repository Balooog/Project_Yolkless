# PX-019.2 — Environment Tick & Performance Validation

## Summary
PX-019.2 measures and validates the timing of the **Sandbox environment tick** against the simulation and HUD update loops.  
It establishes deterministic frame cadence under both interactive and headless modes and defines performance thresholds enforced by CI.

---

## Objectives
- Profile `sandbox_tick` and `environment_tick` duration under Vulkan, OpenGL, and headless builds.  
- Ensure synchronization with `economy_tick` and `stats_tick`.  
- Detect and report drift or frame-time variance exceeding defined thresholds.  
- Document replay benchmark expectations for CI gating.

---

## Tick Relationships
```

sandbox_tick  → drives  environment_tick
↘ updates economy_tick → feeds StatBus (StatsProbe)
HUD_tick      → samples StatBus every frame (UI update)

```

Each tick uses `SimulationClock.gd` as its reference timer.  
`environment_tick` is the slowest allowed loop, capped at 16 ms per frame (≈ 60 Hz).

---

## Performance Targets

| Tick | Target (ms) | Alert Threshold | Failure Threshold | Notes |
|:-----|-------------:|----------------:|------------------:|-------|
| **environment_tick** | ≤ 2.5 ms | > 2.8 ms | > 3.0 ms | Main world update |
| **sandbox_tick** | ≤ 2.0 ms | > 2.2 ms | > 2.5 ms | Physics & props |
| **economy_tick** | ≤ 1.8 ms | > 2.0 ms | > 2.3 ms | Econ calc loop |
| **stats_tick** | ≤ 0.5 ms | > 0.7 ms | > 1.0 ms | StatBus writer |

When any tick exceeds its **failure threshold** for ≥ 3 consecutive frames,  
`tools/replay_headless.gd` logs a red warning and the CI run fails.

---

## Replay Validation Procedure
```bash
timeout 300s $(bash tools/godot_resolver.sh) \
  --headless --script res://tools/replay_headless.gd --duration=300 --seed=42
```

* Output: `dev/logs/replay_metrics.csv`
* Fields: `frame, environment_tick, sandbox_tick, economy_tick, stats_tick`
* CI step parses for sustained overruns.

---

## CI Integration

* `tools/check_only_ci.sh` runs a 60 s quick replay (`--duration=60`)
  and fails if > 5 frames exceed alert thresholds.
* Full replay (300 s) runs nightly via `ui-baseline-assert` workflow.

---

## Acceptance

|   ID   | Requirement                                     | Method                  |
| :----: | ----------------------------------------------- | ----------------------- |
| **A1** | Ticks synchronized within ±0.2 ms average drift | Replay metrics analysis |
| **A2** | No sustained threshold breaches (> 3 frames)    | CI replay run           |
| **A3** | Metrics CSV generated and parsed in CI          | Workflow log            |
| **A4** | Doc thresholds mirror StatsProbe constants      | Review `StatsProbe.gd`  |

---

*Last updated {{ site.time | date: "%Y-%m-%d %H:%M UTC" }}*
